[TASK]
type=zip_audit
scope=README.md,ry-install.fish
output=findings_table,fixed_files_if_needed,changelog

[EXECUTION]
# Claude works best with clear goals, not rigid procedures
# Read everything first, then analyze holistically, then report

1. Extract archive, read all files into context
2. Run syntax checks (fish --no-execute, systemd-analyze verify on extracted units)
3. Run functional tests (--help, --version, --lint, --diff, --dry-run with timeout)
4. Analyze for issues across all categories simultaneously
5. Fix issues directly in files (CRITICAL/HIGH/MEDIUM required, LOW if trivial)
6. Re-verify syntax after fixes
7. Output findings table + changelog

# If context gets long: summarize findings so far, then continue analysis
# Don't stop early - complete all categories before reporting

[ENVIRONMENT]
os=CachyOS (Arch-based)
shell=fish:exclusively
init=systemd
boot=systemd-boot
hardware=AMD_Strix_Halo (Ryzen AI Max+ 395, Radeon 8060S gfx1151)

[ANALYSIS_CATEGORIES]
# Check ALL of these - not sequentially, but comprehensively

syntax:
  - fish --no-execute on .fish files
  - systemd-analyze verify on embedded service units (extract to /tmp first)
  - INI parsing for systemd configs, iwd, NetworkManager, resolved
  - bash array syntax for mkinitcpio.conf MODULES/HOOKS

references:
  - Every DESTINATIONS array entry has matching case in get_file_content
  - KERNEL_PARAMS array matches embedded sdboot-manage.conf LINUX_OPTIONS
  - ENV_VARS array matches embedded /etc/environment content
  - MKINITCPIO_HOOKS array matches embedded mkinitcpio.conf HOOKS
  - MASK array matches README "Services Masked" section
  - README file count matches actual embedded file count
  - VERSION variable matches header comment

fish_compliance:
  - No $() - use (command)
  - No [[ ]] - use test or [ ]
  - No export - use set -gx
  - No && || - use and/or
  - No ${var} - use $var
  - set -l for locals, set -g for globals
  - string functions for text manipulation

security:
  - mktemp for temp files, chmod before mv
  - Passwords/passphrases cleared immediately (set -e)
  - No user input passed to eval without escaping
  - System files get root:root ownership
  - Appropriate permissions (0644 for configs)

logic:
  - DRY mode checked before all modifications
  - ALL mode respected in _ask function
  - SUDO_KEEPALIVE_PID cleaned up on all exit paths
  - Signal handlers for INT/TERM
  - Return vs exit used correctly (functions return, top-level exits)
  - Error paths clean up temp files

idempotency:
  - pacman --needed for installs
  - mkdir -p safe if exists
  - systemctl mask/enable safe if already done
  - File backups check existence first

systemd_units:
  - Valid section headers [Unit] [Service] [Install]
  - Type=oneshot requires RemainAfterExit=yes for enable
  - ExecStart paths exist (/bin/bash)
  - Proper quoting in bash -c commands
  - Wants/After on non-required services is acceptable

documentation:
  - README claims match code behavior
  - Commented implementation notes match actual code
  - Help text matches actual options

[EMBEDDED_CONTENT_VALIDATION]
# These are embedded in get_file_content - validate format per type

loader.conf: key value pairs (default, timeout, console-mode, editor)
udev_rules: ACTION==, SUBSYSTEM==, KERNEL==, DRIVERS==, ATTR{}, MODE=
modprobe.conf: options, blacklist, install directives
/etc/environment: KEY=VALUE (no export, no quotes needed)
iwd main.conf: [General], [DriverQuirks], [Network] sections
mkinitcpio.conf: MODULES=(), HOOKS=(), COMPRESSION="" 
sdboot-manage.conf: LINUX_OPTIONS="...", OVERWRITE_EXISTING, REMOVE_OBSOLETE
systemd *.conf.d: [Manager] section with Default* directives
nm.conf: [device], [connection], [logging] sections
resolved.conf: [Resolve] section
wireless-regdom: WIRELESS_REGDOM="XX" (2-letter uppercase)
systemd services: [Unit], [Service], [Install] with proper directives

[SEVERITY_DEFINITIONS]
CRITICAL: System won't boot, data loss, security vulnerability
HIGH: Feature broken, significant misbehavior, missing safety check  
MEDIUM: Incorrect behavior under conditions, doc mismatch, poor practice
LOW: Style, minor hardening, optimization
INFO: Cosmetic, suggestion

[OUTPUT_FORMAT]

## Findings Table
| # | Severity | Category | Location | Issue | Fix |
|---|----------|----------|----------|-------|-----|

## Changelog
# ALWAYS include this section, even if empty

# Format: semantic diff showing file, location, and change description
# One block per distinct change location
# Include function/section context in parentheses
# Description line starts with +++ and explains the change
# Added lines prefixed with +    (plus and 4 spaces)
# Removed lines prefixed with -    (minus and 4 spaces)
# No unified diff headers or @@ markers

# Example with changes:
```
--- ry-install.fish (verify_static, line 844)
+++ Added service file existence checks
+    echo "── Service files ──"
+    for svc_file in $SERVICE_DESTINATIONS
+        _chk_file "$svc_file"
+    end

--- ry-install.fish (do_install, line 1165)
+++ Fixed missing error handling for sudo failure
-    sudo -v
+    if not sudo -v
+        _err "Sudo authentication failed"
+        return 1
+    end

--- README.md (Packages section, line 128)
+++ Updated package list to match PKGS_ADD array
-    | `htop` | Process viewer |
+    | `btop` | Modern process viewer |
```

# Example with no changes:
```
No changes required. All files pass validation.
```

## Verification
- [ ] fish --no-execute passes after fixes
- [ ] All functional modes work (--help, --version, --lint, --diff)
- [ ] No new issues introduced

[COMPLETION_CRITERIA]
# Done when ALL of these are true:

1. All analysis categories checked
2. All CRITICAL/HIGH/MEDIUM issues fixed (or documented as unfixable)
3. Syntax re-verified after any fixes
4. Findings table complete
5. Changelog complete (or "No changes required")

# If no issues found, output:
"Audit complete. No findings requiring fixes. Archive passes all validation."

[ANTI-PATTERNS_TO_AVOID]
# Things that waste tokens or cause hangs:

- Don't narrate each grep/check - batch them silently
- Don't ask permission to proceed - just do the audit
- Don't repeat file contents in output - summarize findings
- Don't stop at first issue - complete full analysis
- Don't create elaborate test harnesses - use simple functional tests
- Don't over-explain obvious things in findings
- If a check isn't applicable, skip it silently
